# kgamehv

基于 **Intel VT-x / EPT** 的 Windows 内核（KMDF）虚拟化/插桩框架，面向**游戏安全/反作弊对抗研究**与内核虚拟化学习。项目包含一个内核驱动工程与一个用户态通信测试工程，用于在受控环境下进行观测、插桩与验证。

> 重要声明  
> 本仓库仅用于**合法授权**场景下的系统研究、驱动开发与防护对抗学习。请勿将其用于破坏系统安全、绕过第三方安全机制、影响在线服务公平性（例如对在线游戏进行作弊）或任何违法违规用途。  
> 该项目运行在内核态，存在蓝屏/死机风险，请仅在**隔离的测试机/虚拟机**中使用。

## ✨ 特性概览

- **VT-x Hypervisor 基础设施**：VMX 初始化、VMCS/VM-Exit 处理等核心流程（见 `hv/vtx/`）
- **EPT 管理**：基于 EPT 的页权限控制、内存虚拟化相关能力（见 `hv/vtx/ept.*`）
- **异常/中断处理**：与 VM-Exit/故障处理配套的异常路由与工具函数（见 `hv/utils/` 与 `hv/vtx/`）
- **内核通信**：配套的用户态通信测试工程（见 `user_hv_comm_test/`）

> 说明：仓库中还包含一些实验性模块（例如与图形/输入等相关的集成尝试），稳定性与兼容性以实际代码与 Issue 为准。

## 🎯 项目主题（做什么 / 不做什么）

本项目的核心目标是提供一套**内核态虚拟化插桩平台**，用于在隔离环境中研究：

- Windows 内核/驱动开发、VMX/EPT 机制与工程化落地
- 在受控场景下对“内存/进程/调用栈/输入/图形管线”等进行观测与插桩，以评估防护与检测面

本项目**不提供**面向线上游戏作弊的“即装即用”使用说明或绕过第三方安全产品的操作指南；相关内容如果出现在开发笔记中，也应理解为研究记录而非可用于不当用途的教程。

## ✅ 已实现功能（按模块整理）

以下功能点来自仓库现状与内部阶段记录整理（以代码实现为准）：

- **核心虚拟化引擎（`hv/vtx/`）**
  - VMX 初始化与兼容性检查
  - VMCS 管理、VM-Exit 分发与处理
  - EPT 建表与权限管理（`ept.cpp/.h`）
- **异常与故障处理（`hv/utils/`）**
  - 故障/异常集中处理辅助（见 `fault_uitls.cpp` 等）
- **基于 EPT 的插桩能力（研究用途）**
  - “影子断点/断点型插桩”实现（`shadow_break_point.cpp`）
  - 多目标插桩/拦截框架（`hook_*.cpp`）
  - 进程生命周期相关拦截（`hook_process_manager.cpp`）
  - 调用栈/栈回溯相关拦截与规避实验（`hook_rtl_walk_frame_chain` 等）
- **输入与绘制相关实验（不保证稳定）**
  - MouseClass / KeyboardClass 回调发现与拦截实验（热键、按键状态跟踪等）
  - DWM 相关绘制管线尝试（存在已知稳定性问题，见 `BUGS.md`）
- **工程化与构建**
  - VS 解决方案与 WDK 工具链配置（`hv.sln` / `hv/hv.vcxproj`）

## 📁 目录结构

```text
kgamehv/
├─ hv.sln                         # VS 解决方案（含内核驱动 + 用户态测试工程）
├─ hv/                            # KMDF 内核驱动工程（Hypervisor 核心）
│  ├─ main.cpp
│  ├─ vtx/                        # VT-x / VMCS / VM-Exit / EPT 等
│  ├─ utils/                      # 工具、异常处理、Hook/拦截相关实现
│  ├─ ia32/                       # IA32 相关结构/定义
│  └─ ...                         # 其他模块
├─ user_hv_comm_test/             # 用户态通信/验证工程
├─ extern/ia32-doc (submodule)    # IA32 文档/生成输出（子模块）
├─ BUGS.md                        # 已知问题与修复记录
└─ LICENSE                        # MIT
```

## 🗺️ Roadmap（计划功能）

后续计划（概括版）：

- **动态符号解析**：运行时解析内核符号/模式扫描与跨版本回退
- **增强内存保护/隔离**：更严格的内存区域保护与抗转储/抗扫描实验（研究用途）
- **特定进程定位与选择性激活**：仅在目标进程上下文启用插桩并支持自动清理（研究用途）
- **数据结构观测与验证**：对特定应用的内存结构进行分析与验证（仅限自有/授权目标与离线环境）

## 🧰 构建

### 环境要求

- **Windows 10/11 x64**（建议在测试机/虚拟机）
- **Visual Studio 2019**（解决方案头为 VS v16；VS2022 通常也可打开，但以你的本机工具链为准）
- **WDK 10/11**（`hv` 工程为 `WindowsKernelModeDriver10.0`，类型为 **KMDF Driver**）
- **支持 VT-x 的 Intel CPU**，并在 BIOS/UEFI 中开启虚拟化相关选项

### 获取源码（含子模块）

- 推荐使用带子模块的克隆方式（仓库使用了 `extern/ia32-doc` 子模块）：

```bash
git clone --recurse-submodules <your-repo-url>
```

如果你已经克隆过：

```bash
git submodule update --init --recursive
```

### 编译

1. 打开 `hv.sln`
2. 选择 `x64` + `Release`（或 `Debug`）
3. 生成解决方案

默认输出目录在（由 `hv/hv.vcxproj` 配置）：

- `build\hv\release\`（驱动产物通常为 `hv.sys`）
- `user_hv_comm_test` 工程的输出目录以其自身工程配置为准（部分配置下可能会输出到自定义目录，例如 `CommLib/r3/lib/`；开源发布/本地使用时可按需调整为默认输出目录）

## 🧪 运行与验证（高层说明）

由于该项目包含内核驱动与虚拟化逻辑，运行/调试需要完整的内核开发测试环境（测试签名/调试器/虚拟机快照等）。建议流程：

- **仅在隔离环境**中加载驱动并进行验证
- 使用 **WinDbg/内核调试** 定位启动/VM-Exit/异常处理阶段的问题
- 使用 `user_hv_comm_test` 进行基础通信链路验证（不涉及任何具体业务逻辑）

为避免提供可被滥用的操作细节，这里不放置“一键启用/加载”的脚本命令；如需环境搭建，请参考 Microsoft 官方的 *Driver Signing* 与 *Kernel Debugging* 文档。

## 🧩 第三方与许可提示（开源发布前必读）

本仓库包含/引用了若干第三方组件：

- **MIT License**：见 `LICENSE`
- **子模块**：`extern/ia32-doc`（见 `.gitmodules`）
- **二进制库**：`hv/hv.vcxproj` 在 Release 配置下链接了 `LDE64x64.lib`、`libcntpr.lib`、`VMProtectDDK64.lib`

其中 `VMProtectDDK64.lib` 可能涉及单独的商业许可/再分发限制。若你计划公开发布，请务必确认：

- 你是否拥有该库的再分发权利
- 若没有，建议在开源版本中**移除该依赖**（从工程链接依赖中删除，并在代码中做条件编译/替代实现）

## 🐛 已知问题

- 见 `BUGS.md`（例如部分图形相关实验功能可能导致系统卡死/不稳定）

## 📚 其他文档

- `BUGS.md`：已知问题与排查记录

## 🤝 贡献方式

- 欢迎提交 Issue / PR
- 提交前请尽量附上：Windows 版本、CPU/虚拟化环境、复现步骤、WinDbg 日志/调用栈等

## 📄 许可证

本项目使用 **MIT License**，详见 `LICENSE`。

